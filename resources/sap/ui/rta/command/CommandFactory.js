/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayUtil","sap/ui/dt/OverlayRegistry","sap/ui/fl/Utils","sap/ui/dt/Util","sap/base/util/merge"],function(M,E,O,a,F,D,m){"use strict";function e(A){var B=O.getAggregationInformation(A);if(B.elementId){var G=a.getOverlay(B.elementId);var P=G.getParentElementOverlay();var H=P?!!O.getAggregationInformation(P).templateId:false;if(H){throw D.createError("CommandFactory#evaluateTemplateBinding","Multiple template bindings are not supported","sap.ui.rta");}var T=E.extractTemplateId(B);if(T){return{templateSelector:B.elementId,originalSelector:T,content:{boundAggregation:B.aggregation}};}}return undefined;}function g(A,I){var B=(typeof A==="string")?sap.ui.getCore().byId(A):A;var G=a.getOverlay(B);if(G){var H=O.getAggregationInformation(G);if(typeof I==="number"){H.stack[0].index=I;}return E.extractTemplateId(H);}return B.getId();}function b(A){if(!A){throw new Error("adjustment for template failed");}}function c(A,B,G){var H;var J=false;if(typeof(G)==="string"){H=G;}else{H=G&&G.changeType;J=G&&G.jsOnly;}if(!H){return false;}B.setChangeType(H);B.setJsOnly(J);return true;}function d(A,S,B){var G={changeType:"addXML"};if(B){jQuery.extend(G,B.getAction("addXML",A));}return G;}function f(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);}function h(A,S,B){var N=S.element||sap.ui.getCore().byId(S.element.id);var G=B.getActionDataFromAggregations("createContainer",N)[0];return G;}function i(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.parentId=g(S.parentId);b(S.parentId);}function j(A,S,B){var G=S.movedElements[0].element||sap.ui.getCore().byId(S.movedElements[0].id);var H=B.getAction("move",G);if(!H&&B.getMetadata().getName()==="sap.ui.dt.ElementDesignTimeMetadata"){H=B.getActionDataFromAggregations("move",A).filter(function(I){return I.aggregation===S.source.aggregation;})[0];}return H;}function k(S){var T=S.movedElements.map(function(A){var B=sap.ui.getCore().byId(g(A.element,A.sourceIndex));b(B);return B;});S.movedElements.forEach(function(A,B){A.element=T[B];});S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.source.parent=sap.ui.getCore().byId(g(S.source.parent));b(S.source.parent);S.target.parent=sap.ui.getCore().byId(g(S.target.parent));b(S.target.parent);}function l(A,S,B){var R=S.renamedElement;var G=B.getAction("rename",R);return G;}function n(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.renamedElement=sap.ui.getCore().byId(g(S.renamedElement));b(S.renamedElement);}function o(A,S,B){var R=S.removedElement;if(!R){R=A;}else if(!(R instanceof M)){throw new Error("No valid 'removedElement' found");}var G=B.getAction("remove",R);return G;}function p(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.removedElement=sap.ui.getCore().byId(g(S.removedElement));b(S.removedElement);}function q(A,S,B){var G=S.source;var H=B.getAction("combine",G);return H;}function r(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.source=sap.ui.getCore().byId(g(S.source));b(S.source);var T=S.combineElements.map(function(A){A=sap.ui.getCore().byId(g(A));b(A);return A;});S.combineElements=T;}function s(A,S,B){var G=S.source;var H=B.getAction("split",G);return H;}function t(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.parentElement=sap.ui.getCore().byId(g(S.parentElement));b(S.parentElement);S.source=sap.ui.getCore().byId(g(S.source));b(S.source);}function u(A,S,B){var N=S.element;var G=B.getAction("addODataProperty",N);return G;}function v(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.parentId=g(S.parentId);b(S.parentId);}function w(A,S,B){var R=S.element;var G=B.getAction("reveal",R);return G;}function x(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);if(S.revealedElementId){S.revealedElementId=g(S.revealedElementId);b(S.revealedElementId);}if(S.directParent){S.directParent=sap.ui.getCore().byId(g(S.directParent));b(S.directParent);}}function y(A,S,B){var G=B.getAction("add",S.element);if(G&&G.custom&&typeof G.custom.getItems==="function"){var H={changeOnRelevantContainer:S.changeOnRelevantContainer,changeType:S.changeType};delete S["changeOnRelevantContainer"];return H;}}var C={composite:{clazz:'sap.ui.rta.command.CompositeCommand',noSelector:true},property:{clazz:'sap.ui.rta.command.Property',adjustForBinding:f},bindProperty:{clazz:'sap.ui.rta.command.BindProperty'},addXML:{clazz:'sap.ui.rta.command.AddXML',configure:d,adjustForBinding:f},createContainer:{clazz:'sap.ui.rta.command.CreateContainer',configure:h,adjustForBinding:i},move:{clazz:'sap.ui.rta.command.Move',configure:j,adjustForBinding:k},remove:{clazz:'sap.ui.rta.command.Remove',configure:o,adjustForBinding:p},rename:{clazz:'sap.ui.rta.command.Rename',configure:l,adjustForBinding:n},addODataProperty:{clazz:'sap.ui.rta.command.AddODataProperty',configure:u,adjustForBinding:v},reveal:{clazz:'sap.ui.rta.command.Reveal',configure:w,adjustForBinding:x},customAdd:{clazz:'sap.ui.rta.command.CustomAdd',configure:y},combine:{clazz:'sap.ui.rta.command.Combine',configure:q,adjustForBinding:r},split:{clazz:'sap.ui.rta.command.Split',configure:s,adjustForBinding:t},"switch":{clazz:'sap.ui.rta.command.ControlVariantSwitch'},duplicate:{clazz:'sap.ui.rta.command.ControlVariantDuplicate'},setTitle:{clazz:'sap.ui.rta.command.ControlVariantSetTitle'},configure:{clazz:'sap.ui.rta.command.ControlVariantConfigure'},settings:{clazz:'sap.ui.rta.command.Settings'},addLibrary:{clazz:'sap.ui.rta.command.appDescriptor.AddLibrary',noSelector:true},appDescriptor:{clazz:'sap.ui.rta.command.AppDescriptorCommand',noSelector:true}};function _(A,B,S,G,H,V){B=B[0].toLowerCase()+B.slice(1);var I=C[B];var J=H;if(!I){return Promise.reject(D.createError("CommandFactory#_getCommandFor","Command '"+B+"' doesn't exist, check typing","sap.ui.rta"));}return new Promise(function(R){var K=I.clazz;sap.ui.require([K.replace(/\./g,"/")],function(L){R(L);});}).then(function(K){var L=A instanceof M;if(!I.noSelector){S=Object.assign({},S,!L&&{selector:A});}S=Object.assign({},S,{element:L?A:undefined,name:B});var N;if(I.configure){N=I.configure(A,S,G);}var P;if(L){P=a.getOverlay(A);}if(N&&N.changeOnRelevantContainer){Object.assign(S,{element:P.getRelevantContainer()});A=S.element;P=a.getOverlay(A);}var T;if(P&&A.sParentAggregationName){T=e(P);}if(T){if(I.adjustForBinding){I.adjustForBinding(S);}J=m(T,J);}var Q=new K(S);var R=true;if(I.configure){R=c(A,Q,N);}if(R){return Promise.resolve().then(function(){return Q.prepare(J,V);}).then(function(U){if(U){return Q;}});}Q.destroy();return undefined;});}var z=M.extend("sap.ui.rta.command.CommandFactory",{metadata:{library:"sap.ui.rta",properties:{flexSettings:{type:"object"}},associations:{},events:{}}});z.prototype.init=function(){this.setProperty("flexSettings",{layer:"CUSTOMER",developerMode:true});};z.prototype.setFlexSettings=function(A){this.setProperty("flexSettings",jQuery.extend(this.getFlexSettings(),A));};z.prototype.getCommandFor=function(A,B,S,G,V){return _(A,B,S,G,this.getFlexSettings(),V);};z.getCommandFor=function(A,B,S,G,H){if(!H){H={layer:"CUSTOMER",developerMode:true};}if(H.scenario||H.baseId){var L=F.buildLrepRootNamespace(H.baseId,H.scenario,H.projectId);H.rootNamespace=L;H.namespace=L+"changes/";}return _(A,B,S,G,H);};return z;},true);
