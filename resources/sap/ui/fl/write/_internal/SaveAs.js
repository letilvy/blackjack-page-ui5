/*
 * ! OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/descriptorRelated/api/DescriptorVariantFactory","sap/ui/fl/transport/TransportSelection","sap/ui/fl/descriptorRelated/api/DescriptorInlineChangeFactory","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/Utils","sap/base/Log","sap/base/util/includes","sap/base/util/merge"],function(D,T,a,C,F,L,i,m){"use strict";function _(A,p){var s=A.getSettings();if(p&&p.package&&p.transport&&!s.isAtoEnabled()&&!s.isAtoAvailable()){return Promise.resolve({packageName:p.package,transport:p.transport});}if(s.isAtoEnabled()&&s.isAtoAvailable()){var t=new T();return t.openTransportSelection(A);}return Promise.resolve({packageName:"$TMP",transport:""});}function b(A,t){if(t){if(t.transport&&t.packageName!=="$TMP"){return A.setTransportRequest(t.transport).then(A.setPackage(t.packageName));}return Promise.resolve();}return Promise.reject();}function c(s){var j=C.getDescriptorFlexControllerInstance(s)._oChangePersistence.getDirtyChanges();j=j.slice();return j;}function d(s){var I=[];c(s).forEach(function(o){if(i(a.getDescriptorChangeTypes(),o.getChangeType())){var j=o.getDefinition();I.push(a.createNew(j.changeType,j.content,j.texts));}});return Promise.all(I);}function e(s,A){var u=C.getFlexControllerInstance(s)._oChangePersistence.getDirtyChanges();u.forEach(function(o){var j=A.getSettings();if(j.isAtoEnabled()&&j.isAtoAvailable()){o.setRequest("ATO_NOTIFICATION");}var p={reference:A.getId()};var k=F.createNamespace(p,"changes");o.setNamespace(k);o.setComponent(A.getId());if(A.getVersion()){o.setValidAppVersions({creation:A.getVersion(),from:A.getVersion()});}});}function f(A,o){var j=[];A.forEach(function(I){I.replaceHostingIdForTextKey(o.getId(),o.getReference(),I.getContent(),I.getTexts());j.push(o.addDescriptorInlineChange(I));});return Promise.all(j);}function g(A){var t=new T();return t.openTransportSelection(A);}function h(A,p){var s=A.getSettings();if(p&&p.transport&&!s.isAtoEnabled()&&!s.isAtoAvailable()){return Promise.resolve({packageName:A.getPackage(),transport:p.transport});}return g(A);}var S={saveAs:function(p){var A;var o;return D.createAppVariant(p).then(function(j){A=m({},j);return _(A,p);}).then(function(t){return b(A,t);}).then(function(){e(p.selector,A);return d(p.selector);}).then(function(j){return f(j,A);}).then(function(){return A.submit().catch(function(E){E.messageKey="MSG_SAVE_APP_VARIANT_FAILED";E.saveAsFailed=true;throw E;});}).then(function(r){o=m({},r);var j=C.getFlexControllerInstance(p.selector);return j.saveAll(true).catch(function(E){return this.deleteAppVar(p.id).then(function(){E.messageKey="MSG_COPY_UNSAVED_CHANGES_FAILED";throw E;});}.bind(this));}.bind(this)).then(function(){c(p.selector).forEach(function(j){if(i(a.getDescriptorChangeTypes(),j.getChangeType())){C.getDescriptorFlexControllerInstance(p.selector)._oChangePersistence.deleteChange(j);}});return o;}).catch(function(E){L.error("the app variant could not be created.",E.message||E.name);throw E;});},deleteAppVar:function(p){var A;return D.loadAppVariant(p.referenceAppId,true).catch(function(E){E.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw E;}).then(function(o){A=m({},o);return h(A,p);}).then(function(t){if(t){if(t.transport&&t.packageName!=="$TMP"){if(t.transport){return A.setTransportRequest(t.transport);}}return t;}throw new Error("Transport information could not be determined");}).then(function(){return A.submit().catch(function(E){E.messageKey="MSG_DELETE_APP_VARIANT_FAILED";throw E;});}).catch(function(E){L.error("the app variant could not be deleted.",E.message||E.name);throw E;});}};return S;},true);
